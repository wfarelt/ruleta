{% extends "base.html" %}
{% block content %}

<div class="container text-center mt-5">
    <div class="row">
        <div class="col-md-8">
            <h2>{{ pasanaku.name }}</h2>

            <canvas id="wheelCanvas" width="500" height="500"></canvas>

            <br><br>

            <button id="spinButton" class="btn btn-primary">
                Girar Ruleta
            </button>

            <h3 class="mt-4" id="winnerText"></h3>
        </div>
        <div class="col-md-4">
            <h4>Participantes</h4>
            <ul class="list-group text-start">
                {% for p in participants_all %}
                    {% if p.is_winner %}
                        <li class="list-group-item list-group-item-success">
                            {{ p.participant.full_name }} 
                            <span class="badge bg-success float-end">Ganador</span>
                        </li>
                    {% else %}
                        <li class="list-group-item">{{ p.participant.full_name }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Winwheel CDN -->

{% load static %}
{% csrf_token %}

<script src="{% static 'js/Winwheel.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
    let participants = [
        {% for p in participants %}
            {
                id: {{ p.id }},
                text: "{{ p.participant.full_name }}"
            },
        {% endfor %}
    ];

    let wheel;

    function buildWheel() {

        wheel = new Winwheel({
            canvasId: 'wheelCanvas',
            numSegments: participants.length,
            segments: participants.map(p => ({
                text: p.text
            })),
            animation: {
                type: 'spinToStop',
                duration: 5,
                spins: 8
            }
        });
    }

    buildWheel();

    document.getElementById('spinButton').addEventListener('click', function() {

        fetch("/draws/execute/{{ pasanaku.id }}/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {

            if (!data.success) {
                alert(data.message);
                return;
            }

            let winnerIndex = participants.findIndex(p => p.id === data.winner_id);

            let stopAt = winnerIndex + 1;

            wheel.animation.stopAngle = wheel.getRandomForSegment(stopAt);


            wheel.animation.callbackFinished = function() {
                document.getElementById("winnerText").innerHTML =
                    "ðŸŽ‰ Ganador: " + data.winner_name;

                participants.splice(winnerIndex, 1);

                if (participants.length === 0) {
                    document.getElementById("spinButton").disabled = true;
                }

                buildWheel();

                // Refrescar la vista despuÃ©s de 2 segundos
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            };

            wheel.startAnimation();
        });
    });
</script>

{% endblock %}