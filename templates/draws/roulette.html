{% extends "base.html" %}
{% block content %}

<div class="container text-center mt-5">
    <div class="row">
        <div class="col-md-8">
            <h2>{{ pasanaku.name }}</h2>
            <br><br>

            <div style="position: relative; display: inline-block;">
                <!-- Pointer Mano Emoji -->
                <div id="hand-pointer" style="
                    position: absolute;
                    left: 50%;
                    top: 0px;
                    transform: translate(-50%, -90%);
                    font-size: 2.5rem;
                    z-index: 10;
                    pointer-events: none;
                    user-select: none;
                ">ðŸ‘‡</div>
                <canvas id="wheelCanvas" width="500" height="500"></canvas>
            </div>

            <br><br>

            <button id="spinButton" class="btn btn-primary">
                Girar Ruleta
            </button>

            <button id="resetButton" class="btn btn-warning" style="display:none;">
                Reiniciar Juego
            </button>

            <h3 class="mt-4" id="winnerText"></h3>
        </div>
        <div class="col-md-4">
            <h4>Participantes</h4>
            <ul class="list-group text-start">
                {% for p in participants_all %}
                    {% if p.is_winner %}
                        <li class="list-group-item list-group-item-success">
                            {{ p.participant.full_name }} 
                            <span class="badge bg-success float-end">Ganador</span>
                        </li>
                    {% else %}
                        <li class="list-group-item">{{ p.participant.full_name }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Winwheel CDN -->

{% load static %}
{% csrf_token %}

<script src="{% static 'js/Winwheel.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
    let participants = [
        {% for p in participants %}
            {
                id: {{ p.id }},
                text: "{{ p.participant.full_name }}"
            },
        {% endfor %}
    ];

    let wheel;
    // Usar el Ã¡ngulo del backend
    let lastRotationAngle = {{ rotation_angle|default:0 }};


    // Paleta de colores para los segmentos
    const segmentColors = [
        '#f39c12', '#27ae60', '#2980b9', '#8e44ad', '#e67e22', '#16a085', '#c0392b', '#2c3e50', '#d35400', '#7f8c8d',
        '#e84393', '#00b894', '#fdcb6e', '#0984e3', '#6c5ce7', '#00cec9', '#fab1a0', '#636e72', '#fd79a8', '#81ecec'
    ];

    function buildWheel() {
        wheel = new Winwheel({
            canvasId: 'wheelCanvas',
            lineWidth: 3,
            numSegments: participants.length,
            segments: participants.map((p, i) => ({
                text: p.text,
                fillStyle: segmentColors[i % segmentColors.length]
            })),
            animation: {
                type: 'spinToStop',
                duration: 6,
                spins: 15
            },
            rotationAngle: lastRotationAngle
        });
    }

    buildWheel();

    // Mostrar el botÃ³n de reinicio si ya no hay participantes al cargar la pÃ¡gina
    if (participants.length === 0) {
        document.getElementById("spinButton").disabled = true;
        document.getElementById("resetButton").style.display = "inline-block";
    }

    // Listener para el botÃ³n de reinicio (solo una vez)
    document.getElementById("resetButton").addEventListener("click", function() {
        if (!confirm("Â¿Seguro que deseas reiniciar el juego?")) return;
        fetch("/draws/reset/{{ pasanaku.id }}/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message);
            }
        });
    });

    document.getElementById('spinButton').addEventListener('click', function() {

        fetch("/draws/execute/{{ pasanaku.id }}/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `rotation_angle=${encodeURIComponent(wheel.rotationAngle)}`
        })
        .then(response => response.json())
        .then(data => {

            if (!data.success) {
                alert(data.message);
                return;
            }


            let winnerIndex = participants.findIndex(p => p.id === data.winner_id);
            let stopAt = winnerIndex + 1;

            // Calcular el Ã¡ngulo del segmento ganador
            let segmentAngle = 360 / participants.length;
            let targetAngle = wheel.getRandomForSegment(stopAt);
            // Asegurar que el stopAngle sea mayor que el Ã¡ngulo inicial
            let spins = wheel.animation.spins || 15;
            let stopAngle = lastRotationAngle + spins * 360 + (targetAngle - lastRotationAngle % 360);
            wheel.animation.stopAngle = stopAngle;


            wheel.animation.callbackFinished = function() {
                document.getElementById("winnerText").innerHTML =
                    "ðŸŽ‰ Ganador: " + data.winner_name;

                participants.splice(winnerIndex, 1);

                // Guardar el Ã¡ngulo final para el prÃ³ximo giro en el backend (sin sortear)
                lastRotationAngle = wheel.rotationAngle;
                fetch(`/draws/save_angle/{{ pasanaku.id }}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `rotation_angle=${encodeURIComponent(lastRotationAngle)}`
                });

                if (participants.length === 0) {
                    document.getElementById("spinButton").disabled = true;
                    document.getElementById("resetButton").style.display = "inline-block";
                }

                buildWheel();

                // Refrescar la vista despuÃ©s de 2 segundos
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
            };

            wheel.startAnimation();
        });
    });
</script>

{% endblock %}